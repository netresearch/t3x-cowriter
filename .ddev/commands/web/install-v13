#!/bin/bash

## Description: Install TYPO3 v13.4 with t3_cowriter extension
## Usage: install-v13
## Example: ddev install-v13

set -e

TYPO3_VERSION="^13.4"
INSTALL_DIR="/var/www/html/v13"
DB_NAME="v13"
EXTENSION_KEY="t3_cowriter"
PACKAGE_NAME="netresearch/t3-cowriter"

echo "=== Installing TYPO3 ${TYPO3_VERSION} ==="

# Drop and recreate database for clean install
mariadb -e "DROP DATABASE IF EXISTS ${DB_NAME};"
mariadb -e "CREATE DATABASE ${DB_NAME};"
mariadb -e "GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO 'db'@'%'; FLUSH PRIVILEGES;"

# Clean install directory and fix ownership (volume may be root-owned)
sudo rm -rf ${INSTALL_DIR}/* ${INSTALL_DIR}/.[!.]*
sudo chown "$(id -u):$(id -g)" ${INSTALL_DIR}
cd ${INSTALL_DIR}

# Create TYPO3 project
composer create-project typo3/cms-base-distribution:${TYPO3_VERSION} . --no-interaction

# Remove platform PHP override if set
composer config --unset platform.php 2>/dev/null || true

# Allow dev dependencies (needed for nr-llm and extension during development)
composer config minimum-stability dev
composer config prefer-stable true

# Add nr-llm repository (needed for development version)
composer config repositories.nr-llm vcs https://github.com/netresearch/t3x-nr-llm

# Add extension as path repository (mounted at /var/www/t3_cowriter)
composer config repositories.extension path /var/www/t3_cowriter
composer require ${PACKAGE_NAME}:@dev --no-interaction

# Install TYPO3
vendor/bin/typo3 setup \
    --driver=mysqli \
    --host=db \
    --port=3306 \
    --dbname=${DB_NAME} \
    --username=db \
    --password=db \
    --admin-username=admin \
    --admin-user-password='Joh316!!' \
    --admin-email=admin@example.com \
    --project-name="TYPO3 v13 - t3_cowriter" \
    --no-interaction \
    --force

# Configure for DDEV multi-domain
cat >> config/system/additional.php << 'EOF'
<?php
$GLOBALS['TYPO3_CONF_VARS']['SYS']['trustedHostsPattern'] = '.*';
$GLOBALS['TYPO3_CONF_VARS']['SYS']['features']['security.backend.enforceReferrer'] = false;
EOF

# Set up extensions
vendor/bin/typo3 extension:setup

# Clear cache
vendor/bin/typo3 cache:flush

echo ""
echo "=== TYPO3 v13.4 installed successfully ==="
echo "Backend: https://v13.${DDEV_SITENAME}.ddev.site/typo3/"
echo "Login: admin / Joh316!!"
