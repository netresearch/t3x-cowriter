name: PR Quality Gates
on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]
permissions: {}
jobs:
  quality-gate:
    name: PR Size Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    permissions:
      pull-requests: write
    steps:
      - name: Harden runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - name: Check PR size
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
            });

            const additions = pr.additions || 0;
            const deletions = pr.deletions || 0;
            const totalChanges = additions + deletions;
            const changedFiles = pr.changed_files || 0;

            core.info(`PR #${pr.number}: +${additions} -${deletions} (${totalChanges} total) across ${changedFiles} files`);

            if (totalChanges > 1000) {
              const body = [
                '> [!WARNING]',
                `> **Large PR detected**: ${totalChanges} lines changed across ${changedFiles} files.`,
                '> Consider splitting this PR into smaller, focused changes for easier review.',
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body,
              });

              core.warning(`PR has ${totalChanges} lines changed — consider splitting`);
            }

  auto-approve:
    name: Auto-Approve (solo maintainer)
    runs-on: ubuntu-latest
    needs: quality-gate
    if: github.event.pull_request.draft == false
    permissions:
      pull-requests: write
    steps:
      - name: Harden runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - name: Auto-approve PR
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const pr = context.payload.pull_request;

            // Only auto-approve PRs from the repository owner or known bots
            const trustedAuthors = [
              'dependabot[bot]',
              'renovate[bot]',
            ];

            const { data: repoData } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const isOwner = pr.user.login === repoData.owner.login;
            const isTrustedBot = trustedAuthors.includes(pr.user.login);

            if (!isOwner && !isTrustedBot) {
              core.info(`PR author ${pr.user.login} is not the repo owner or a trusted bot — skipping auto-approve`);
              return;
            }

            // Check if there are any pending reviewers (e.g. Copilot still reviewing)
            const { data: reviewRequests } = await github.rest.pulls.listRequestedReviewers({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
            });

            if (reviewRequests.users.length > 0 || reviewRequests.teams.length > 0) {
              core.info('Pending reviewers detected — skipping auto-approve to avoid race condition');
              return;
            }

            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              event: 'APPROVE',
              body: 'Auto-approved: quality gates passed.',
            });

            core.info(`Auto-approved PR #${pr.number}`);
